<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Von Neumann Probe Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-thumb::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-white">Von Neumann Probe Colonization</h1>
            <p class="text-lg text-gray-400 mt-2">An interactive simulation of exponential expansion across a galaxy.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Simulation Canvas -->
            <div class="flex-grow bg-black rounded-xl shadow-2xl overflow-hidden border border-gray-700">
                <canvas id="galaxyCanvas"></canvas>
            </div>

            <!-- Controls and Stats -->
            <div class="lg:w-96 flex-shrink-0 space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Controls</h2>
                    <div class="space-y-5">
                        <!-- Star Count Control -->
                        <div>
                            <label for="starSlider" class="block mb-2 text-sm font-medium">Number of Stars</label>
                            <div class="flex items-center gap-4">
                                <input id="starSlider" type="range" min="100" max="10000" step="100" value="500" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
                                <span id="starValue" class="font-mono text-indigo-400 w-20 text-center">500</span>
                            </div>
                        </div>
                        <!-- Speed Control -->
                        <div>
                            <label for="speedSlider" class="block mb-2 text-sm font-medium">Probe Speed (% of light speed)</label>
                            <div class="flex items-center gap-4">
                                <input id="speedSlider" type="range" min="1" max="50" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
                                <span id="speedValue" class="font-mono text-indigo-400 w-12 text-center">10%</span>
                            </div>
                        </div>
                        <!-- Replication Time Control -->
                        <div>
                            <label for="replicationSlider" class="block mb-2 text-sm font-medium">Replication Time (Years)</label>
                             <div class="flex items-center gap-4">
                                <input id="replicationSlider" type="range" min="100" max="5000" step="100" value="1000" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
                                <span id="replicationValue" class="font-mono text-indigo-400 w-20 text-center">1000</span>
                            </div>
                        </div>
                        <!-- Expiration Risk Control -->
                        <div>
                            <label for="expirationSlider" class="block mb-2 text-sm font-medium">Expiration Risk (% per 1k years)</label>
                             <div class="flex items-center gap-4">
                                <input id="expirationSlider" type="range" min="0" max="50" step="1" value="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider-thumb">
                                <span id="expirationValue" class="font-mono text-indigo-400 w-20 text-center">5%</span>
                            </div>
                        </div>
                        <!-- Continuous Production Toggle -->
                        <div class="flex items-center justify-between">
                            <label for="continuousProduction" class="text-sm font-medium">Continuous Production</label>
                            <input id="continuousProduction" type="checkbox" class="h-5 w-5 accent-indigo-600">
                        </div>
                    </div>
                    <div class="flex gap-4 mt-6">
                        <button id="startPauseBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Start</button>
                        <button id="resetBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Reset</button>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Statistics</h2>
                    <div class="grid grid-cols-2 gap-y-4 gap-x-2 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Elapsed Time</p>
                            <p id="timeElapsed" class="text-xl font-bold text-indigo-400">0 Years</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Active Probes</p>
                            <p id="probeCount" class="text-xl font-bold text-indigo-400">0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Stars Visited</p>
                            <p id="starsVisited" class="text-xl font-bold text-indigo-400">0 / 500</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Galaxy Colonized</p>
                            <p id="colonizationPercentage" class="text-xl font-bold text-indigo-400">0%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Galaxy Diameter</p>
                            <p id="galaxyDiameter" class="text-xl font-bold text-indigo-400">0 LY</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Probes Lost</p>
                            <p id="probesLost" class="text-xl font-bold text-red-400">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Graph Section -->
        <div class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 h-80">
             <h2 class="text-2xl font-semibold text-white mb-4 text-center">Simulation Progress</h2>
            <canvas id="progressChart"></canvas>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Canvas and Context Setup ---
            const canvas = document.getElementById('galaxyCanvas');
            const ctx = canvas.getContext('2d');
            const chartCanvas = document.getElementById('progressChart');

            // --- Performance Optimization ---
            const offscreenCanvas = document.createElement('canvas');
            const offscreenCtx = offscreenCanvas.getContext('2d');
            
            // --- DOM Element References ---
            const starSlider = document.getElementById('starSlider');
            const starValue = document.getElementById('starValue');
            const speedSlider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');
            const replicationSlider = document.getElementById('replicationSlider');
            const replicationValue = document.getElementById('replicationValue');
            const expirationSlider = document.getElementById('expirationSlider');
            const expirationValue = document.getElementById('expirationValue');
            const continuousProduction = document.getElementById('continuousProduction');
            const startPauseBtn = document.getElementById('startPauseBtn');
            const resetBtn = document.getElementById('resetBtn');
            const timeElapsedEl = document.getElementById('timeElapsed');
            const probeCountEl = document.getElementById('probeCount');
            const starsVisitedEl = document.getElementById('starsVisited');
            const colonizationPercentageEl = document.getElementById('colonizationPercentage');
            const probesLostEl = document.getElementById('probesLost');
            const galaxyDiameterEl = document.getElementById('galaxyDiameter');

            // --- Simulation Constants ---
            const AVG_STAR_DISTANCE_LY = 5;
            const TIME_STEP_YEARS = 50;
            const CHART_UPDATE_INTERVAL = 10; // Update chart every 10 game loops (500 years)
            let numStars = 500;
            let galaxyDiameterLY = 0;
            let loopCounter = 0;

            // --- Simulation State ---
            let stars = [];
            let probes = [];
            let timeElapsed = 0;
            let probesLost = 0;
            let simulationRunning = false;
            let animationFrameId;
            
            // --- Chart State ---
            let progressChart;
            let chartData = {
                labels: [],
                activeProbes: [],
                starsVisited: [],
                probesLost: []
            };

            // --- Utility Functions ---
            const resizeCanvas = () => {
                const container = canvas.parentElement;
                const size = Math.min(container.clientWidth, window.innerHeight * 0.6);
                canvas.width = size;
                canvas.height = size;
                offscreenCanvas.width = size;
                offscreenCanvas.height = size;
                draw();
            };

            const formatYears = (years) => {
                if (years < 1000) return `${Math.round(years)} Years`;
                if (years < 1000000) return `${(years / 1000).toFixed(1)}k`;
                return `${(years / 1000000).toFixed(2)}M`;
            };
            
            // --- Charting ---
            function setupChart() {
                const chartCtx = chartCanvas.getContext('2d');
                progressChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            { label: 'Active Probes', data: chartData.activeProbes, borderColor: '#6366f1', backgroundColor: '#6366f120', tension: 0.1, yAxisID: 'y' },
                            { label: 'Stars Visited', data: chartData.starsVisited, borderColor: '#34d399', backgroundColor: '#34d39920', tension: 0.1, yAxisID: 'y1' }, // Assigned to y1
                            { label: 'Probes Lost', data: chartData.probesLost, borderColor: '#f87171', backgroundColor: '#f8717120', tension: 0.1, yAxisID: 'y' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Time (Years)', color: '#9ca3af' }, ticks: { color: '#9ca3af' } },
                            y: { // Left Y-Axis for Probes
                                type: 'linear', display: true, position: 'left',
                                title: { display: true, text: 'Probe Count', color: '#9ca3af' },
                                ticks: { color: '#9ca3af' }
                            },
                            y1: { // Right Y-Axis for Stars
                                type: 'linear', display: true, position: 'right',
                                title: { display: true, text: 'Stars Visited', color: '#9ca3af' },
                                ticks: { color: '#9ca3af' },
                                grid: { drawOnChartArea: false } // only want the grid from the left axis
                            }
                        },
                        plugins: { legend: { labels: { color: '#d1d5db' } } }
                    }
                });
            }
            
            function updateChart() {
                if (!progressChart) return;
                const visitedCount = stars.filter(s => s.visited).length;
                chartData.labels.push(formatYears(timeElapsed));
                chartData.activeProbes.push(probes.length);
                chartData.starsVisited.push(visitedCount);
                chartData.probesLost.push(probesLost);
                progressChart.update();
            }

            // --- Simulation Core ---
            function createStars() {
                stars = [];
                numStars = parseInt(starSlider.value);
                const areaPerStar = AVG_STAR_DISTANCE_LY * AVG_STAR_DISTANCE_LY;
                const totalGalaxyArea = numStars * areaPerStar;
                galaxyDiameterLY = Math.sqrt(4 * totalGalaxyArea / Math.PI);

                for (let i = 0; i < numStars; i++) {
                    const r = Math.random() * Math.random() * (canvas.width / 2);
                    const angle = Math.random() * 2 * Math.PI;
                    stars.push({
                        x: canvas.width / 2 + r * Math.cos(angle),
                        y: canvas.height / 2 + r * Math.sin(angle),
                        visited: false, claimed: false,
                        radius: Math.random() * 1.5 + 0.5,
                        productionTimer: 0
                    });
                }
            }

            function findClosestUnclaimedStar(x, y) {
                let closestStar = null;
                let minDistance = Infinity;
                for (const star of stars) {
                    if (!star.visited && !star.claimed) {
                        const distance = Math.hypot(star.x - x, star.y - y);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestStar = star;
                        }
                    }
                }
                return closestStar;
            }

            class Probe {
                constructor(x, y) {
                    this.x = x; this.y = y; this.status = 'seeking';
                    this.targetStar = null; this.replicationTimer = 0;
                    this.isDecommissioned = false; this.findNewTarget();
                }

                findNewTarget() {
                    this.targetStar = findClosestUnclaimedStar(this.x, this.y);
                    if (this.targetStar) {
                        this.targetStar.claimed = true;
                        this.status = 'traveling';
                    } else {
                        this.status = 'idle';
                    }
                }

                update() {
                    const riskPer1kYears = parseInt(expirationSlider.value) / 100;
                    if (riskPer1kYears > 0) {
                        const riskPerYear = riskPer1kYears / 1000;
                        const survivalProbability = Math.pow(1 - riskPerYear, TIME_STEP_YEARS);
                        if (Math.random() > survivalProbability) {
                            this.isDecommissioned = true;
                            if (this.targetStar && this.status === 'traveling') {
                                this.targetStar.claimed = false;
                            }
                            return;
                        }
                    }

                    if (this.status === 'traveling' && this.targetStar) {
                        const targetX = this.targetStar.x; const targetY = this.targetStar.y;
                        const distanceToTarget = Math.hypot(targetX - this.x, targetY - this.y);
                        
                        const speedOfLightFraction = parseInt(speedSlider.value) / 100;
                        const travelLyPerStep = speedOfLightFraction * TIME_STEP_YEARS;
                        const travelPixelsPerStep = (travelLyPerStep / galaxyDiameterLY) * canvas.width;

                        if (distanceToTarget <= travelPixelsPerStep) {
                            this.x = targetX; this.y = targetY;
                            if (!this.targetStar.visited) this.targetStar.visited = true;
                            this.status = 'replicating';
                            this.replicationTimer = parseInt(replicationSlider.value);
                            // Initialize continuous production timer for colonized star
                            if (this.targetStar && this.targetStar.visited && this.targetStar.productionTimer === 0) {
                                this.targetStar.productionTimer = parseInt(replicationSlider.value);
                            }
                        } else {
                            const angle = Math.atan2(targetY - this.y, targetX - this.x);
                            this.x += Math.cos(angle) * travelPixelsPerStep;
                            this.y += Math.sin(angle) * travelPixelsPerStep;
                        }
                    } else if (this.status === 'replicating') {
                        this.replicationTimer -= TIME_STEP_YEARS;
                        if (this.replicationTimer <= 0) {
                            probes.push(new Probe(this.x, this.y));
                            this.findNewTarget();
                        }
                    }
                }
            }
            
            // --- OPTIMIZED DRAWING FUNCTIONS ---
            function drawStaticStarfield() {
                offscreenCtx.fillStyle = 'black';
                offscreenCtx.fillRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                stars.forEach(star => {
                    offscreenCtx.beginPath();
                    offscreenCtx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
                    offscreenCtx.fillStyle = '#a0a0a0'; // All stars start as gray
                    offscreenCtx.fill();
                });
            }

            function draw() {
                // 1. Copy the pre-rendered starfield
                ctx.drawImage(offscreenCanvas, 0, 0);

                // 2. Draw only the visited stars (as blue) and probes
                stars.forEach(star => {
                    if (star.visited) {
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
                        ctx.fillStyle = '#4f46e5';
                        ctx.fill();
                    }
                });

                probes.forEach(probe => {
                    ctx.beginPath();
                    ctx.arc(probe.x, probe.y, 3, 0, 2 * Math.PI);
                    ctx.fillStyle = '#4f46e5';
                    ctx.fill();
                    ctx.strokeStyle = '#a5b4fc';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                });
            }


            function updateStats() {
                const visitedCount = stars.filter(s => s.visited).length;
                const percentage = numStars > 0 ? (visitedCount / numStars) * 100 : 0;
                
                timeElapsedEl.textContent = formatYears(timeElapsed);
                probeCountEl.textContent = probes.length;
                starsVisitedEl.textContent = `${visitedCount} / ${numStars}`;
                colonizationPercentageEl.textContent = `${percentage.toFixed(1)}%`;
                probesLostEl.textContent = probesLost;
                galaxyDiameterEl.textContent = `${Math.round(galaxyDiameterLY)} LY`;

                if (visitedCount === numStars && numStars > 0 && simulationRunning) {
                    simulationRunning = false;
                    startPauseBtn.textContent = 'Done';
                    startPauseBtn.disabled = true;
                    cancelAnimationFrame(animationFrameId);
                }
            }

            function gameLoop() {
                if (!simulationRunning) return;
                timeElapsed += TIME_STEP_YEARS;
                loopCounter++;
                
                probes.forEach(probe => probe.update());
                
                // Continuous production: colonized stars spawn probes periodically
                if (continuousProduction && continuousProduction.checked) {
                    const period = parseInt(replicationSlider.value);
                    stars.forEach(star => {
                        if (star.visited) {
                            star.productionTimer -= TIME_STEP_YEARS;
                            if (star.productionTimer <= 0) {
                                probes.push(new Probe(star.x, star.y));
                                star.productionTimer = period;
                            }
                        }
                    });
                }
                
                const initialProbeCount = probes.length;
                probes = probes.filter(probe => !probe.isDecommissioned);
                probesLost += initialProbeCount - probes.length;
                
                draw();
                updateStats();
                
                if (loopCounter % CHART_UPDATE_INTERVAL === 0) updateChart();
                animationFrameId = requestAnimationFrame(gameLoop);
            }

            function resetSimulation() {
                simulationRunning = false;
                cancelAnimationFrame(animationFrameId);
                
                timeElapsed = 0; probesLost = 0; probes = []; loopCounter = 0;
                
                chartData.labels.length = 0;
                chartData.activeProbes.length = 0;
                chartData.starsVisited.length = 0;
                chartData.probesLost.length = 0;
                
                resizeCanvas(); 
                createStars();
                drawStaticStarfield(); // Pre-render the background
                
                if (stars.length > 0) {
                    const firstStar = stars[Math.floor(stars.length / 2)];
                    firstStar.visited = true;
                    firstStar.productionTimer = parseInt(replicationSlider.value);
                    probes.push(new Probe(firstStar.x, firstStar.y));
                }

                draw();
                updateStats();
                updateChart();
                
                startPauseBtn.textContent = 'Start';
                startPauseBtn.disabled = false;
            }
            
            // --- Event Listeners ---
            startPauseBtn.addEventListener('click', () => {
                simulationRunning = !simulationRunning;
                startPauseBtn.textContent = simulationRunning ? 'Pause' : 'Resume';
                if (simulationRunning) gameLoop();
            });
            resetBtn.addEventListener('click', resetSimulation);
            starSlider.addEventListener('input', (e) => {
                starValue.textContent = e.target.value;
                resetSimulation();
            });
            speedSlider.addEventListener('input', (e) => { speedValue.textContent = `${e.target.value}%`; });
            replicationSlider.addEventListener('input', (e) => { replicationValue.textContent = e.target.value; });
            expirationSlider.addEventListener('input', (e) => { expirationValue.textContent = `${e.target.value}%`; });
            // Changing replication time updates production cadence for continuous mode
            replicationSlider.addEventListener('input', () => {
                const period = parseInt(replicationSlider.value);
                stars.forEach(star => {
                    if (star.visited) {
                        // Align next spawn roughly to new period without bursting
                        star.productionTimer = Math.min(star.productionTimer, period);
                    }
                });
            });
            window.addEventListener('resize', resetSimulation);

            // --- Initial Call ---
            setupChart();
            resetSimulation();
        });
    </script>
</body>
</html>
